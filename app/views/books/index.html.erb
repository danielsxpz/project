<div class="admin-header">
  <h1>Acervo de Livros</h1>
  <div class="dashboard-buttons">
    <%= link_to 'Novo Livro', new_book_path, class: 'btn-primary' %>
    <%= link_to 'Gerenciar Categorias', categories_path, class: 'btn-secondary' %>
    <%= link_to 'Gerenciar Usuários', users_path, class: 'btn-secondary' %>
  </div>
</div>

<div class="search-bar">
  <%= form_with(url: books_path, method: :get, local: true) do |form| %>
    <%= form.text_field :query, value: params[:query], placeholder: "Pesquisar por título..." %>
    
    <%= form.collection_select :category, @categories, :id, :name, 
      { include_blank: 'Todas as Categorias', selected: params[:category] },
      { class: 'category-select' } %>

    <%= form.submit "Filtrar" %>
  <% end %>
</div>

<div data-controller="loan-modal">

  <table class="admin-table stylish-table">
    <thead>
      <tr>
        <th>Título</th>
        <th>Autor</th>
        <th>Categoria</th>
        <th>Status</th>
        <th>Ação</th>
      </tr>
    </thead>
    <tbody>
      <% @books.each do |book| %>
        <tr>
          <td><%= book.title %></td>
          <td><%= book.author %></td>
          <td><%= book.category.name %></td>
          <td>
            <span class="status-tag status-<%= book.status.parameterize %>">
              <%= book.status %>
            </span>
          </td>
          <td>
            <% if book.status == 'Disponível' %>
              <%= link_to 'Emprestar', new_book_loan_path(book), class: 'btn-loan' %>
            <% else %>
              <button data-action="click->loan-modal#open" 
                      data-loan-id="<%= book.active_loan&.id %>"
                      data-book-title="<%= book.title %>"
                      class="btn-info">
                Ver Mais
              </button>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <%# O modal agora está DENTRO do controller, mas sem a declaração 'data-controller' nele mesmo %>
  <div data-loan-modal-target="modal" class="modal-backdrop hidden">
    <div class="modal-content">
      <button data-action="click->loan-modal#close" class="modal-close-button">&times;</button>
      <h2>Detalhes do Empréstimo</h2>
      
      <div data-loan-modal-target="details">
        <p><strong>Livro:</strong> <span data-loan-modal-target="bookTitle"></span></p>
        <p><strong>Emprestado para:</strong> <span data-loan-modal-target="userName"></span></p>
        <p><strong>Data do Empréstimo:</strong> <span data-loan-modal-target="loanDate"></span></p>
        <p><strong>Data de Devolução:</strong> <span data-loan-modal-target="dueDate"></span></p>
      </div>

      <div class="modal-actions">
        <button data-action="click->loan-modal#returnBook" class="btn-success">Marcar como Devolvido</button>
      </div>
    </div>
  </div>

</div>